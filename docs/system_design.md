# EventMonitor システム設計書

## アカウントタイプと処理フロー

### 1. 監視アカウント（通常アカウント）
**account_type: normal** (またはevent_detection_enabled=1)

#### 処理フロー
1. TwitterからツイートをAPI/twscrapeで取得
2. gallery-dlでメディアをダウンロード（images/ディレクトリ）
3. LLMでイベント参加関連ツイートを検出
4. イベントツイートをDiscordに通知
5. HydrusClientでメディアをインポート
6. all_tweetsテーブルにツイート情報を保存
7. **メディアファイルは削除しない**（Hydrus/手動管理用）

#### 設定の影響
- `huggingface_backup.enabled: false` の場合
  - HuggingFaceへのアップロードはスキップ
  - DBへの保存は実行される
  - ローカルファイルは保持

### 2. ログ専用アカウント
**account_type: log**

#### 処理フロー
1. TwitterからツイートをAPI/twscrapeで取得
2. gallery-dlでメディアをダウンロード（data/media/ディレクトリ）
3. **必ずHuggingFaceにアップロード**（設定に関係なく）
4. log_only_tweetsテーブルに保存
5. **アップロード成功後、ローカルファイルを削除**（容量節約）
6. LLM処理、Discord通知、Hydrusインポートは**すべてスキップ**

#### 設定の影響
- `huggingface_backup.enabled` の設定は無視される
- 常にHuggingFaceへアップロードする

## ファイル管理方針

### メディアファイルの保存先
- **監視アカウント**: `images/` ディレクトリ
  - ユーザー名ごとのサブディレクトリ
  - 永続的に保持
  
- **ログアカウント**: `data/media/` ディレクトリ  
  - 一時的な保存（アップロード後削除）
  - gallery-dlのデフォルト出力先

### ファイル削除ポリシー
| アカウントタイプ | HFアップロード | ファイル削除 | 理由 |
|--------------|------------|----------|------|
| 監視アカウント | 設定依存 | **削除しない** | Hydrus/Discord/手動管理で必要 |
| ログアカウント | 常に実行 | **削除する** | バックアップ完了後は不要、容量節約 |

## データベース構造

### all_tweetsテーブル
- 監視アカウントのツイート
- イベント検知対象
- HF URLsは設定に応じて格納

### log_only_tweetsテーブル  
- ログアカウントのツイート
- イベント検知しない
- 必ずHF URLsを格納

### event_tweetsテーブル
- LLMがイベント関連と判定したツイート
- 監視アカウントのみ
- Discord通知対象

## 処理の最適化

### gallery-dlのタイムアウト設定
- デフォルト: 2時間（7200秒）
- レート制限を考慮した十分な時間
- 大量のツイート（800件程度）でも完了可能

### バッチ処理
- ログアカウント: 1ツイートごとにHFアップロード→DB保存
- 成功したもののみDBに記録（トランザクション的処理）

### 鍵アカウント（非公開アカウント）対応
- twscrapeの`user.protected`フィールドで鍵アカウントを自動判定
- 鍵アカウントには指定のCookie/アカウントを使用（フォロー済みアカウント）
- 通常のローテーションではなく、config.yamlで指定した固定Cookie/アカウントを使用
- 新着0件の場合は処理をスキップ（鍵アカウントでも同様）

## エラーハンドリング

### HFアップロード失敗時
- 監視アカウント: ローカルファイルは保持、DBには保存しない
- ログアカウント: ローカルファイルは保持、DBには保存しない、後でリトライ

### gallery-dl失敗時
- タイムアウトエラー: プロセス強制終了、部分的なダウンロード
- レート制限: 自動的に待機（gallery-dl内部処理）